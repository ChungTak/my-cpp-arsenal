name: Build librockchip RK35XX

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build and Release
    runs-on: ubuntu-latest
    container:
      image: ubuntu:17.04
      options: --user root
    env:
      OUTPUT_ROOT: outputs/librockchip_rk35xx
    steps:
      - name: 准备容器环境
        shell: bash
        run: |
          export DEBIAN_FRONTEND=noninteractive
          export TZ=Etc/UTC
          if command -v sudo >/dev/null 2>&1; then
            sudo sed -i 's|http://archive.ubuntu.com/ubuntu|http://old-releases.ubuntu.com/ubuntu|g' /etc/apt/sources.list
            sudo ln -fs /usr/share/zoneinfo/"$TZ" /etc/localtime
            sudo apt-get update
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends tzdata
            sudo dpkg-reconfigure --frontend noninteractive tzdata
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y git build-essential unzip curl wget ninja-build pkg-config python3 python3-pip python3-venv
          else
            sed -i 's|http://archive.ubuntu.com/ubuntu|http://old-releases.ubuntu.com/ubuntu|g' /etc/apt/sources.list
            ln -fs /usr/share/zoneinfo/"$TZ" /etc/localtime
            apt-get update
            DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends tzdata
            dpkg-reconfigure --frontend noninteractive tzdata
            DEBIAN_FRONTEND=noninteractive apt-get install -y git build-essential unzip curl wget ninja-build pkg-config python3 python3-pip python3-venv
          fi

      - name: 检出仓库
        uses: actions/checkout@v4
        with:
          repository: ChungTak/my-cpp-arsenal
          submodules: true

      - name: 升级 pip 并安装 Meson 与 CMake
        shell: bash
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install cmake==3.28
          python3 -m pip install meson

      - name: 安装交叉编译工具链
        shell: bash
        run: |
          chmod +x install_toolchain.sh
          ALLOW_ROOT=1 ./install_toolchain.sh --gnu-only --skip-test

      - name: 准备 librockchip 构建脚本
        shell: bash
        run: chmod +x scripts/librockchip/build_rk35xx.sh

      - name: 构建 librockchip RK35XX (aarch64-linux-gnu-debug)
        shell: bash
        run: ./scripts/librockchip/build_rk35xx.sh aarch64-linux-gnu-debug

      - name: 构建 librockchip RK35XX (aarch64-linux-gnu)
        shell: bash
        run: ./scripts/librockchip/build_rk35xx.sh aarch64-linux-gnu

      - name: 构建 librockchip RK35XX (arm-linux-gnueabihf)
        shell: bash
        run: ./scripts/librockchip/build_rk35xx.sh arm-linux-gnueabihf

      - name: Setup Android NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25c
          local-cache: true
          add-to-path: true

      - name: 导出 ANDROID_NDK_HOME
        if: steps.setup-ndk.outputs.ndk-path != ''
        shell: bash
        run: echo "ANDROID_NDK_HOME=${{ steps.setup-ndk.outputs.ndk-path }}" >> "$GITHUB_ENV"

      - name: 构建 librockchip RK35XX (aarch64-linux-android)
        shell: bash
        run: ./scripts/librockchip/build_rk35xx.sh aarch64-linux-android

      - name: 构建 librockchip RK35XX (arm-linux-android)
        shell: bash
        run: ./scripts/librockchip/build_rk35xx.sh arm-linux-android

      - name: 压缩构建产物
        shell: bash
        run: |
          set -euo pipefail
          cd "$OUTPUT_ROOT"
          for dir in aarch64-linux-gnu-debug aarch64-linux-gnu arm-linux-gnueabihf aarch64-linux-android arm-linux-android; do
            if [ ! -d "$dir" ]; then
              echo "::error::缺少目录 $OUTPUT_ROOT/$dir" >&2
              exit 1
            fi
            tar -czf "$dir.tar.gz" "$dir"
          done

      - name: 解析版本号
        id: version
        shell: bash
        run: |
          set -euo pipefail
          release_file="$OUTPUT_ROOT/release.txt"
          if [ ! -f "$release_file" ]; then
            echo "::error::未找到 release 文件 $release_file" >&2
            exit 1
          fi
          version_line=$(grep -E '^rknpu2=' "$release_file" | head -n1 || true)
          if [ -z "$version_line" ]; then
            echo "::error::无法在 $release_file 中找到 rknpu2= 行" >&2
            exit 1
          fi
          version=${version_line#rknpu2=}
          version=$(echo "$version" | tr -d ' \r\n\t')
          if [ -z "$version" ]; then
            echo "::error::解析到的 rknpu2 版本为空" >&2
            exit 1
          fi
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "release_tag=librockchip-$version" >> "$GITHUB_OUTPUT"

      - name: 发布 Release
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ steps.version.outputs.release_tag }}
          name: librockchip-${{ steps.version.outputs.version }}
          bodyFile: outputs/librockchip_rk35xx/release.txt
          artifacts: |
            outputs/librockchip_rk35xx/aarch64-linux-gnu-debug.tar.gz
            outputs/librockchip_rk35xx/aarch64-linux-gnu.tar.gz
            outputs/librockchip_rk35xx/arm-linux-gnueabihf.tar.gz
            outputs/librockchip_rk35xx/aarch64-linux-android.tar.gz
            outputs/librockchip_rk35xx/arm-linux-android.tar.gz
          allowUpdates: true
          replacesArtifacts: true
